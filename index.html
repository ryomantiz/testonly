<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ä‡∏°‡∏£‡∏°‡∏£‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏â‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏á‡πÜ ‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•‡∏õ‡∏•‡∏≤‡∏ã‡∏¥‡∏ß</title>
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Itim font and general aesthetics */
        body {
            font-family: 'Itim', cursive;
            background-color: #f0f4f8; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to allow scrolling */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Toast notification container styling */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse; /* New toasts appear on top */
            gap: 0.5rem;
        }

        .toast {
            background-color: #334155; /* Dark slate */
            color: #e2e8f0;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOut 3s forwards; /* Fade in, stay, fade out */
            min-width: 200px;
            max-width: 300px;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.success {
            background-color: #10b981; /* Green */
        }

        .toast.error {
            background-color: #ef4444; /* Red */
        }

        .toast.info {
            background-color: #3b82f6; /* Blue */
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Modal styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff, #f0f9ff); /* Light gradient */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
            border: 1px solid #cbd5e1; /* Light border */
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #64748b;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close-button:hover {
            color: #1e293b;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* View Toggle Buttons */
        .view-toggle-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .view-toggle-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 400; /* Normal font weight */
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #e2e8f0; /* slate-200 */
            color: #475569; /* slate-600 */
            border: 1px solid #cbd5e1; /* slate-300 */
        }

        .view-toggle-button.active {
            background-color: #3b82f6; /* blue-500 */
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        .view-toggle-button:hover:not(.active) {
            background-color: #cbd5e1; /* slate-300 */
            color: #1e293b; /* slate-900 */
        }

        /* Person View Controls (Filter) */
        .person-view-controls {
            display: flex;
            flex-direction: column; /* Stack filter and cards vertically */
            align-items: center; /* Center filter horizontally */
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .person-view-controls select {
            padding: 0.75rem 1.5rem; /* Increased padding */
            border-radius: 0.75rem; /* More rounded */
            border: 1px solid #475569; /* Darker border for contrast */
            background-color: #475569; /* Gray background */
            color: #ffffff; /* White text */
            font-size: 1.125rem; /* Larger font size */
            font-weight: 400; /* Normal font weight */
            cursor: pointer;
            appearance: none; /* Remove default arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em 1.5em;
            width: 100%; /* Make it wide */
            max-width: 400px; /* Limit max width to match card width */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Add shadow */
        }

        /* Card group container for responsive grid (for person view) */
        .person-card-group-container {
            display: flex; /* Changed to flex for single column */
            flex-direction: column; /* Ensure single column */
            gap: 2rem; /* Space between group cards */
        }

        /* Styles for individual group cards (for person view) */
        .group-card {
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); /* Deeper shadow */
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Space between heading and user list */
            width: 100%; /* Ensure it takes full width of its container */
            max-width: 400px; /* Limit width to match filter */
            margin-left: auto; /* Center the card */
            margin-right: auto; /* Center the card */
        }

        .group-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        /* Specific theme classes for group cards */
        .theme-0-99 {
            background-color: #e0f2fe; /* blue-50 */
            border: 1px solid #bfdbfe; /* blue-200 */
        }
        .theme-0-99 .group-card-heading {
            color: #1e40af; /* blue-800 */
        }
        .theme-0-99 .user-list-item-name,
        .theme-0-99 .user-list-item-pages {
            color: #2563eb; /* blue-600 */
        }

        .theme-100-999 {
            background-color: #dcfce7; /* green-50 */
            border: 1px solid #a7f3d0; /* green-200 */
        }
        .theme-100-999 .group-card-heading {
            color: #166534; /* green-800 */
        }
        .theme-100-999 .user-list-item-name,
        .theme-100-999 .user-list-item-pages {
            color: #22c55e; /* green-600 */
        }

        .theme-1000-4999 {
            background-color: #ede9fe; /* violet-50 */
            border: 1px solid #c4b5fd; /* violet-200 */
        }
        .theme-1000-4999 .group-card-heading {
            color: #5b21b6; /* violet-800 */
        }
        .theme-1000-4999 .user-list-item-name,
        .theme-1000-4999 .user-list-item-pages {
            color: #7c3aed; /* violet-600 */
        }

        .theme-5000-9999 {
            background-color: #fff7ed; /* orange-50 */
            border: 1px solid #fed7aa; /* orange-200 */
        }
        .theme-5000-9999 .group-card-heading {
            color: #c2410c; /* orange-800 */
        }
        .theme-5000-9999 .user-list-item-name,
        .theme-5000-9999 .user-list-item-pages {
            color: #ea580c; /* orange-600 */
        }

        .theme-10000-plus {
            background-color: #fee2e2; /* red-50 */
            border: 1px solid #fecaca; /* red-200 */
        }
        .theme-10000-plus .group-card-heading {
            color: #991b1b; /* red-800 */
        }
        .theme-10000-plus .user-list-item-name,
        .theme-10000-plus .user-list-item-pages {
            color: #dc2626; /* red-600 */
        }

        /* Group heading style */
        .group-card-heading {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 400; /* Normal font weight */
            text-align: center;
            margin-bottom: 0.5rem; /* mb-2 */
            padding-bottom: 0.5rem;
            border-bottom: 2px solid; /* Border color will be set by theme */
        }

        /* User list inside group card */
        .user-list-in-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Space between user entries */
        }

        .user-list-item {
            display: flex;
            justify-content: space-between; /* Changed to space-between for left alignment */
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            background-color: rgba(255, 255, 255, 0.6); /* Slightly transparent white background for items */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .user-list-item:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .user-list-item-name {
            flex-grow: 1;
            font-weight: 400; /* Normal font weight */
            font-size: 1rem; /* text-base */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left; /* Aligned to left */
            margin-right: 0.5rem; /* Small space before pages */
        }

        .user-list-item-pages {
            flex-shrink: 0;
            font-weight: 400; /* Normal font weight */
            font-size: 0.9rem; /* Slightly smaller for compactness */
            text-align: right; /* Align pages to the right */
        }

        /* Book View Controls (Search and Sort) */
        .book-view-controls {
            display: flex;
            flex-direction: column; /* Stack input and buttons vertically */
            align-items: center; /* Center them */
            gap: 1rem;
            margin-bottom: 1.5rem;
            width: 100%; /* Will be capped by JS maxWidth */
            margin-left: auto; /* Center the controls */
            margin-right: auto; /* Center the controls */
        }

        .book-view-controls input[type="text"] {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            background-color: #ffffff;
            font-size: 1rem;
            color: #475569;
            width: 100%; /* Take full width of parent (which is dynamically sized) */
            font-weight: 400; /* Normal font weight */
        }

        .book-view-controls .sort-buttons-group {
            display: flex;
            gap: 0.5rem;
            width: 100%; /* Take full width of parent */
            justify-content: center; /* Center the buttons within the group */
        }

        .book-view-controls button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 400; /* Normal font weight */
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #e2e8f0; /* slate-200 */
            color: #475569; /* slate-600 */
            border: 1px solid #cbd5e1; /* slate-300 */
        }

        .book-view-controls button:hover {
            background-color: #cbd5e1;
        }

        .book-view-controls button.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }


        /* Book Title Display (New View) */
        .book-title-display-container {
            display: flex; /* Changed to flex for single column list */
            flex-direction: column; /* Ensure single column */
            gap: 0.75rem; /* Space between book title cards */
            width: 100%; /* Will be capped by JS maxWidth */
            margin-left: auto; /* Center the container */
            margin-right: auto; /* Center the container */
        }

        .book-title-card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* Slightly smaller radius for list items */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); /* Lighter shadow for list items */
            padding: 1rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column; /* Keep content centered */
            justify-content: center;
            align-items: center;
            width: 100%; /* Take full width of its container (which is dynamically sized) */
            /* Removed max-width: 400px; */
        }

        .book-title-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .book-title-card-text {
            font-size: 1.25rem; /* text-xl, slightly smaller for list items */
            font-weight: 400; /* Normal font weight */
            color: #1e293b; /* slate-900 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%; /* Ensure it takes full width */
        }

        /* Modal list item styling (for both user's books and book's readers) */
        .modal-list-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #e0f2fe; /* blue-50, consistent with previous modal items */
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: background-color 0.2s ease;
        }

        .modal-list-entry:hover {
            background-color: #cceeff; /* Lighter blue on hover */
        }

        .modal-list-entry-name {
            font-weight: 400; /* Normal font weight */
            color: #334155; /* slate-700 */
            flex-grow: 1; /* Allow title/name to take available space */
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis;
            margin-right: 1rem; /* Space between name/title and pages */
            text-align: left; /* Align name/title to the left */
        }

        .modal-list-entry-pages {
            color: #1d4ed8; /* blue-700 */
            font-weight: 400; /* Normal font weight */
            flex-shrink: 0; /* Prevent pages from shrinking */
            text-align: right; /* Align pages to the right */
        }

        /* Site title */
        h1 {
            font-weight: 400; /* Normal font weight */
        }

        /* Modal title */
        #modal-title {
            font-weight: 400; /* Normal font weight */
        }

        /* Teacher Dashboard specific styles */
        #teacher-dashboard-container {
            max-width: 600px; /* Limit width for forms */
            margin-left: auto;
            margin-right: auto;
        }

        #teacher-dashboard-container input[type="text"],
        #teacher-dashboard-container input[type="number"],
        #teacher-dashboard-container select {
            font-weight: 400; /* Normal font weight */
            color: #1e293b;
        }

        #teacher-dashboard-container button {
            font-weight: 400; /* Normal font weight */
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-2xl max-w-7xl w-full">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8 mt-4">
            üìö ‡∏ä‡∏°‡∏£‡∏°‡∏£‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏â‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏á‡πÜ ‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•‡∏õ‡∏•‡∏≤‡∏ã‡∏¥‡∏ß üìö
        </h1>

        <div class="view-toggle-buttons">
            <button id="view-by-person-button" class="view-toggle-button active">‡∏î‡∏π‡∏ï‡∏≤‡∏°‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</button>
            <button id="view-by-book-button" class="view-toggle-button">‡∏î‡∏π‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</button>
            <button id="view-by-teacher-button" class="view-toggle-button">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
        </div>

        <div id="loading-indicator" class="text-center text-gray-600 text-lg mb-4 hidden">
            <div class="loading-spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...</p>
        </div>

        <div id="person-view-controls" class="person-view-controls hidden">
            <select id="group-filter">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</option>
                <option value="10000+ Pages">10000+ ‡∏´‡∏ô‡πâ‡∏≤</option>
                <option value="5000-9999 Pages">5000-9999 ‡∏´‡∏ô‡πâ‡∏≤</option>
                <option value="1000-4999 Pages">1000-4999 ‡∏´‡∏ô‡πâ‡∏≤</option>
                <option value="100-999 Pages">100-999 ‡∏´‡∏ô‡πâ‡∏≤</option>
                <option value="0-99 Pages">0-99 ‡∏´‡∏ô‡πâ‡∏≤</option>
            </select>
        </div>

        <div id="book-view-controls" class="book-view-controls hidden">
            <input type="text" id="book-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠..." >
            <div class="sort-buttons-group">
                <button id="sort-az-button" class="sort-button active">‡∏Å-‡∏Æ</button>
                <button id="sort-za-button" class="sort-button">‡∏Æ-‡∏Å</button>
            </div>
        </div>

        <div id="person-card-display-container" class="person-card-group-container hidden">
            </div>

        <div id="book-title-display-container" class="book-title-display-container hidden">
            </div>

        <div id="teacher-dashboard-container" class="hidden p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-3xl text-gray-800 mb-6 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</h2>

            <div class="mb-8 p-6 border rounded-lg shadow-sm bg-blue-50">
                <h3 class="text-2xl text-blue-800 mb-4 text-center">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="add-person-name" class="block text-gray-700 text-sm font-normal mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà '‡∏ô‡∏∏‡πâ‡∏á'):</label>
                        <input type="text" id="add-person-name" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô MomoKama">
                    </div>
                    <div>
                        <label for="add-book-title" class="block text-gray-700 text-sm font-normal mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠:</label>
                        <input type="text" id="add-book-title" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô Harry Potter">
                    </div>
                    <div class="md:col-span-2">
                        <label for="add-page-count" class="block text-gray-700 text-sm font-normal mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤:</label>
                        <input type="number" id="add-page-count" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 600">
                    </div>
                </div>
                <button id="add-data-button" class="mt-6 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div class="mb-8 p-6 border rounded-lg shadow-sm bg-yellow-50">
                <h3 class="text-2xl text-yellow-800 mb-4 text-center">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-person-select" class="block text-gray-700 text-sm font-normal mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•:</label>
                        <select id="edit-person-select" class="w-full p-2 border rounded-md focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-book-select" class="block text-gray-700 text-sm font-normal mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠:</label>
                        <select id="edit-book-select" class="w-full p-2 border rounded-md focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="edit-page-count" class="block text-gray-700 text-sm font-normal mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:</label>
                        <input type="number" id="edit-page-count" class="w-full p-2 border rounded-md focus:ring-yellow-500 focus:border-yellow-500" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà">
                    </div>
                </div>
                <button id="edit-data-button" class="mt-6 w-full bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 transition-colors">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div class="p-6 border rounded-lg shadow-sm bg-red-50">
                <h3 class="text-2xl text-red-800 mb-4 text-center">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="delete-person-select" class="block text-gray-700 text-sm font-normal mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•:</label>
                        <select id="delete-person-select" class="w-full p-2 border rounded-md focus:ring-red-500 focus:border-red-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
                        </select>
                    </div>
                    <div>
                        <label for="delete-book-select" class="block text-gray-700 text-sm font-normal mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):</label>
                        <select id="delete-book-select" class="w-full p-2 border rounded-md focus:ring-red-500 focus:border-red-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</option>
                        </select>
                    </div>
                </div>
                <button id="delete-data-button" class="mt-6 w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>

        <div id="no-data-message" class="text-center text-gray-500 text-lg p-8 hidden">
            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="details-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-button" class="modal-close-button">&times;</button>
            <h2 id="modal-title" class="text-3xl font-normal text-gray-800 mb-4 text-center"></h2>
            <div id="modal-list-content" class="space-y-3">
                </div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdtlENw0AWEc2aPBHsKxblxuRsdikIUJkKhO7SXZ34esxRByr0d5So809_yK320aVthg/exec';

        // DOM Elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const personCardDisplayContainer = document.getElementById('person-card-display-container');
        const bookTitleDisplayContainer = document.getElementById('book-title-display-container');
        const noDataMessage = document.getElementById('no-data-message');
        const toastContainer = document.getElementById('toast-container');
        const detailsModalOverlay = document.getElementById('details-modal-overlay');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalTitle = document.getElementById('modal-title');
        const modalListContent = document.getElementById('modal-list-content');
        const viewByPersonButton = document.getElementById('view-by-person-button');
        const viewByBookButton = document.getElementById('view-by-book-button');
        const viewByTeacherButton = document.getElementById('view-by-teacher-button'); // New
        const personViewControls = document.getElementById('person-view-controls');
        const bookViewControls = document.getElementById('book-view-controls');
        const teacherDashboardContainer = document.getElementById('teacher-dashboard-container'); // New
        const groupFilterSelect = document.getElementById('group-filter');
        const bookSearchInput = document.getElementById('book-search-input');
        const sortAzButton = document.getElementById('sort-az-button');
        const sortZaButton = document.getElementById('sort-za-button');

        // Teacher Dashboard Form Elements
        const addPersonNameInput = document.getElementById('add-person-name');
        const addBookTitleInput = document.getElementById('add-book-title');
        const addPageCountInput = document.getElementById('add-page-count');
        const addDataButton = document.getElementById('add-data-button');

        const editPersonSelect = document.getElementById('edit-person-select');
        const editBookSelect = document.getElementById('edit-book-select');
        const editPageCountInput = document.getElementById('edit-page-count');
        const editDataButton = document.getElementById('edit-data-button');

        const deletePersonSelect = document.getElementById('delete-person-select');
        const deleteBookSelect = document.getElementById('delete-book-select');
        const deleteDataButton = document.getElementById('delete-data-button');


        let userData = []; // To store the fetched and processed user data
        let booksData = []; // To store processed book-centric data
        let currentView = 'person'; // 'person', 'book', or 'teacher'
        let currentBookSortOrder = 'az'; // 'az' or 'za'

        // Define the order of groups for display
        const groupOrder = [
            '10000+ Pages',
            '5000-9999 Pages',
            '1000-4999 Pages',
            '100-999 Pages',
            '0-99 Pages'
        ];

        // Map group names to their respective theme classes
        const themeClasses = {
            '0-99 Pages': 'theme-0-99',
            '100-999 Pages': 'theme-100-999',
            '1000-4999 Pages': 'theme-1000-4999',
            '5000-9999 Pages': 'theme-5000-9999',
            '10000+ Pages': 'theme-10000-plus'
        };

        // Thai translations for group names
        const thaiGroupNames = {
            '0-99 Pages': '0-99 ‡∏´‡∏ô‡πâ‡∏≤',
            '100-999 Pages': '100-999 ‡∏´‡∏ô‡πâ‡∏≤',
            '1000-4999 Pages': '1000-4999 ‡∏´‡∏ô‡πâ‡∏≤',
            '5000-9999 Pages': '5000-9999 ‡∏´‡∏ô‡πâ‡∏≤',
            '10000+ Pages': '10000+ ‡∏´‡∏ô‡πâ‡∏≤'
        };

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            toast.innerHTML = `
                <span class="text-xl">
                    ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
                </span>
                <span>${message}</span>
            `;
            toastContainer.prepend(toast); // Add new toast on top

            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        /**
         * Fetches book reading data from the Google Apps Script.
         */
        async function fetchData() {
            loadingIndicator.classList.remove('hidden');
            personCardDisplayContainer.classList.add('hidden');
            bookTitleDisplayContainer.classList.add('hidden');
            personViewControls.classList.add('hidden');
            bookViewControls.classList.add('hidden');
            teacherDashboardContainer.classList.add('hidden'); // Hide teacher view
            noDataMessage.classList.add('hidden');
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');

            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data || data.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï', 'info');
                    return;
                }

                userData = data; // Store fetched user data

                // Process data for book view
                const bookMap = new Map();
                userData.forEach(user => {
                    user.books.forEach(book => {
                        if (!bookMap.has(book.title)) {
                            bookMap.set(book.title, { title: book.title, readers: [] });
                        }
                        bookMap.get(book.title).readers.push({ user: user.user, pages: book.pages });
                    });
                });
                booksData = Array.from(bookMap.values()).sort((a, b) => a.title.localeCompare(b.title, 'th')); // Initial sort A-Z (Thai locale)

                populateDropdowns(); // Populate teacher dropdowns after data fetch
                renderViews(); // Render the initial view
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

            } catch (error) {
                console.error('Error fetching data:', error);
                showToast(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                noDataMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Populates the person and book dropdowns in the teacher dashboard.
         */
        function populateDropdowns() {
            // Clear existing options
            editPersonSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>';
            deletePersonSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>';
            editBookSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</option>';
            deleteBookSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</option>';

            // Populate person dropdowns
            const uniquePersons = new Set(userData.map(user => user.user));
            uniquePersons.forEach(person => {
                const option1 = document.createElement('option');
                option1.value = person;
                option1.textContent = `‡∏ô‡∏∏‡πâ‡∏á${person}`;
                editPersonSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = person;
                option2.textContent = `‡∏ô‡∏∏‡πâ‡∏á${person}`;
                deletePersonSelect.appendChild(option2);
            });

            // Populate all unique book titles for edit/delete book dropdowns
            const allUniqueBooks = new Set();
            userData.forEach(user => {
                user.books.forEach(book => {
                    allUniqueBooks.add(book.title);
                });
            });
            Array.from(allUniqueBooks).sort((a,b) => a.localeCompare(b, 'th')).forEach(bookTitle => {
                const option1 = document.createElement('option');
                option1.value = bookTitle;
                option1.textContent = bookTitle;
                editBookSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = bookTitle;
                option2.textContent = bookTitle;
                deleteBookSelect.appendChild(option2);
            });
        }

        /**
         * Updates the book dropdowns in the teacher dashboard based on selected person.
         * @param {HTMLSelectElement} personSelectElement - The person select element.
         * @param {HTMLSelectElement} bookSelectElement - The book select element to update.
         * @param {boolean} allowAllOption - Whether to include an "All Books" option.
         */
        function updateBookDropdownForPerson(personSelectElement, bookSelectElement, allowAllOption = false) {
            const selectedPerson = personSelectElement.value;
            bookSelectElement.innerHTML = ''; // Clear current options

            if (allowAllOption) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)';
                bookSelectElement.appendChild(defaultOption);
            } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠';
                bookSelectElement.appendChild(defaultOption);
            }


            if (selectedPerson) {
                const personData = userData.find(user => user.user === selectedPerson);
                if (personData && personData.books.length > 0) {
                    const personBooks = [...new Set(personData.books.map(book => book.title))].sort((a, b) => a.localeCompare(b, 'th'));
                    personBooks.forEach(bookTitle => {
                        const option = document.createElement('option');
                        option.value = bookTitle;
                        option.textContent = bookTitle;
                        bookSelectElement.appendChild(option);
                    });
                }
            }
        }


        /**
         * Groups users by page count ranges.
         * @param {Array} users - The array of user reading data.
         * @returns {Object} An object with page ranges as keys and arrays of users as values.
         */
        function groupUsersByPages(users) {
            const groups = {
                '0-99 Pages': [],
                '100-999 Pages': [],
                '1000-4999 Pages': [],
                '5000-9999 Pages': [],
                '10000+ Pages': []
            };

            users.forEach(user => {
                const pages = user.total_pages;
                if (pages >= 10000) {
                    groups['10000+ Pages'].push(user);
                } else if (pages >= 5000) {
                    groups['5000-9999 Pages'].push(user);
                } else if (pages >= 1000) {
                    groups['1000-4999 Pages'].push(user);
                } else if (pages >= 100) {
                    groups['100-999 Pages'].push(user);
                } else {
                    groups['0-99 Pages'].push(user);
                }
            });

            // Sort users within each group by total_pages in descending order
            for (const key in groups) {
                groups[key].sort((a, b) => b.total_pages - a.total_pages);
            }

            return groups;
        }

        /**
         * Renders the user data in a card view grouped by page counts.
         * @param {Array} data - The array of user reading data.
         * @param {string} filterGroup - The group name to filter by, or 'all'.
         */
        function renderPersonCards(data, filterGroup = 'all') {
            personCardDisplayContainer.innerHTML = ''; // Clear existing content

            const groupedUsers = groupUsersByPages(data);

            groupOrder.forEach(groupName => {
                if (filterGroup === 'all' || filterGroup === groupName) {
                    const usersInGroup = groupedUsers[groupName];
                    if (usersInGroup && usersInGroup.length > 0) {
                        const groupCard = document.createElement('div');
                        groupCard.classList.add('group-card', themeClasses[groupName]);

                        const heading = document.createElement('h2');
                        heading.classList.add('group-card-heading');
                        heading.textContent = thaiGroupNames[groupName]; // Use Thai group name
                        groupCard.appendChild(heading);

                        const userList = document.createElement('div');
                        userList.classList.add('user-list-in-group');

                        usersInGroup.forEach(user => {
                            const userListItem = document.createElement('div');
                            userListItem.classList.add('user-list-item');
                            userListItem.dataset.id = user.user; // Store user ID for modal
                            userListItem.dataset.type = 'person'; // Indicate type for modal

                            const userNameSpan = document.createElement('span');
                            userNameSpan.classList.add('user-list-item-name');
                            userNameSpan.textContent = `‡∏ô‡∏∏‡πâ‡∏á${user.user}`; // Add '‡∏ô‡∏∏‡πâ‡∏á' prefix
                            userListItem.appendChild(userNameSpan);

                            const userPagesSpan = document.createElement('span');
                            userPagesSpan.classList.add('user-list-item-pages');
                            userPagesSpan.textContent = `${user.total_pages} ‡∏´‡∏ô‡πâ‡∏≤`; // Thai for 'pages'
                            userListItem.appendChild(userPagesSpan);

                            userList.appendChild(userListItem);
                        });
                        groupCard.appendChild(userList);
                        personCardDisplayContainer.appendChild(groupCard);
                    }
                }
            });

            personCardDisplayContainer.classList.remove('hidden');
            bookTitleDisplayContainer.classList.add('hidden');
            teacherDashboardContainer.classList.add('hidden'); // Hide teacher view
            personViewControls.classList.remove('hidden');
            bookViewControls.classList.add('hidden');
        }

        /**
         * Renders the book titles in a list view.
         * @param {Array} data - The array of book data.
         * @param {string} searchTerm - The search term to filter books.
         * @param {string} sortOrder - 'az' or 'za'.
         */
        function renderBookTitles(data, searchTerm = '', sortOrder = 'az') {
            bookTitleDisplayContainer.innerHTML = ''; // Clear existing content

            let filteredBooks = data.filter(book =>
                book.title.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (sortOrder === 'az') {
                filteredBooks.sort((a, b) => a.title.localeCompare(b.title, 'th')); // Sort with Thai locale
            } else {
                filteredBooks.sort((a, b) => b.title.localeCompare(a.title, 'th')); // Sort with Thai locale
            }

            // --- Calculate dynamic width for book cards and controls ---
            let longestTitleWidth = 0;
            const tempCard = document.createElement('div');
            // Apply all relevant styles that affect width
            tempCard.style.position = 'absolute';
            tempCard.style.visibility = 'hidden';
            tempCard.style.padding = '1rem 1.5rem'; // Matches .book-title-card padding
            tempCard.style.border = '1px solid #e2e8f0'; // Matches .book-title-card border
            tempCard.style.borderRadius = '0.75rem'; // Matches .book-title-card border-radius
            tempCard.style.boxSizing = 'border-box'; // Include padding and border in width
            tempCard.style.display = 'flex'; // Mimic flex behavior
            tempCard.style.flexDirection = 'column'; // Mimic flex behavior
            tempCard.style.justifyContent = 'center'; // Mimic flex behavior
            tempCard.style.alignItems = 'center'; // Mimic flex behavior
            tempCard.style.width = 'fit-content'; // Allow it to shrink to content

            const tempTextSpan = document.createElement('span');
            tempTextSpan.style.fontFamily = 'Itim, cursive';
            tempTextSpan.style.fontSize = '1.25rem'; // Matches .book-title-card-text
            tempTextSpan.style.fontWeight = '400'; // Matches .book-title-card-text
            tempTextSpan.style.whiteSpace = 'nowrap'; // Crucial for measuring actual text width
            tempTextSpan.style.overflow = 'hidden';
            tempTextSpan.style.textOverflow = 'clip'; // Use clip to get full text width before ellipsis
            tempTextSpan.style.width = 'auto'; // Allow content to dictate width

            tempCard.appendChild(tempTextSpan);
            document.body.appendChild(tempCard);

            filteredBooks.forEach(book => {
                tempTextSpan.textContent = book.title;
                if (tempCard.offsetWidth > longestTitleWidth) {
                    longestTitleWidth = tempCard.offsetWidth;
                }
            });

            document.body.removeChild(tempCard);

            // Add a small buffer for safety and consistent appearance (e.g., for scrollbar, slight variations)
            const finalCalculatedWidth = longestTitleWidth + 20; // 20px buffer

            // Cap the dynamic width at a reasonable maximum to prevent excessively wide layouts
            const maxAllowedContentWidth = 800; // Max width for the content area (cards and controls)
            const dynamicWidth = Math.min(finalCalculatedWidth, maxAllowedContentWidth);

            // Apply this width to the containers
            bookTitleDisplayContainer.style.maxWidth = `${dynamicWidth}px`;
            bookViewControls.style.maxWidth = `${dynamicWidth}px`;

            // Ensure centering of these containers
            bookTitleDisplayContainer.style.marginLeft = 'auto';
            bookTitleDisplayContainer.style.marginRight = 'auto';
            bookViewControls.style.marginLeft = 'auto';
            bookViewControls.style.marginRight = 'auto';
            // --- End dynamic width calculation ---

            if (filteredBooks.length === 0) {
                const p = document.createElement('p');
                p.classList.add('text-center', 'text-gray-500', 'text-lg', 'p-8', 'w-full');
                p.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';
                bookTitleDisplayContainer.appendChild(p);
            } else {
                filteredBooks.forEach(book => {
                    const bookCard = document.createElement('div');
                    bookCard.classList.add('book-title-card');
                    bookCard.dataset.id = book.title; // Store book title for modal
                    bookCard.dataset.type = 'book'; // Indicate type for modal

                    const bookTitleSpan = document.createElement('span');
                    bookTitleSpan.classList.add('book-title-card-text');
                    bookTitleSpan.textContent = book.title;
                    bookCard.appendChild(bookTitleSpan);

                    bookTitleDisplayContainer.appendChild(bookCard);
                });
            }

            bookTitleDisplayContainer.classList.remove('hidden');
            personCardDisplayContainer.classList.add('hidden');
            teacherDashboardContainer.classList.add('hidden'); // Hide teacher view
            personViewControls.classList.add('hidden');
            bookViewControls.classList.remove('hidden');
        }

        /**
         * Displays the teacher dashboard.
         */
        function renderTeacherDashboard() {
            personCardDisplayContainer.classList.add('hidden');
            bookTitleDisplayContainer.classList.add('hidden');
            personViewControls.classList.add('hidden');
            bookViewControls.classList.add('hidden');
            teacherDashboardContainer.classList.remove('hidden'); // Show teacher view
        }

        /**
         * Displays the user details modal.
         * @param {string} userName - The name of the user.
         */
        function showUserDetails(userName) {
            const user = userData.find(u => u.user === userName);
            if (!user) return;

            modalTitle.textContent = `‡∏ô‡∏∏‡πâ‡∏á${user.user}`; // Add '‡∏ô‡∏∏‡πâ‡∏á' prefix
            modalListContent.innerHTML = ''; // Clear previous content

            if (user.books.length === 0) {
                const p = document.createElement('p');
                p.textContent = '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠';
                p.classList.add('text-gray-600', 'italic', 'text-center');
                modalListContent.appendChild(p);
            } else {
                // Sort books by pages in descending order
                const sortedBooks = [...user.books].sort((a, b) => b.pages - a.pages);

                sortedBooks.forEach(book => {
                    const bookItem = document.createElement('div');
                    bookItem.classList.add('modal-list-entry'); // Use new class for modal list items
                    bookItem.innerHTML = `
                        <span class="modal-list-entry-name">${book.title}</span>
                        <span class="modal-list-entry-pages">${book.pages} ‡∏´‡∏ô‡πâ‡∏≤</span>
                    `;
                    modalListContent.appendChild(bookItem);
                });
            }

            detailsModalOverlay.classList.add('open');
        }

        /**
         * Displays the book details modal.
         * @param {string} bookTitle - The title of the book.
         */
        function showBookDetails(bookTitle) {
            const book = booksData.find(b => b.title === bookTitle);
            if (!book) return;

            modalTitle.textContent = book.title;
            modalListContent.innerHTML = ''; // Clear previous content

            if (book.readers.length === 0) {
                const p = document.createElement('p');
                p.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡πÉ‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ';
                p.classList.add('text-gray-600', 'italic', 'text-center');
                modalListContent.appendChild(p);
            } else {
                // Sort readers by pages in descending order
                const sortedReaders = [...book.readers].sort((a, b) => b.pages - a.pages);

                sortedReaders.forEach(reader => {
                    const readerItem = document.createElement('div');
                    readerItem.classList.add('modal-list-entry'); // Use new class for modal list items
                    readerItem.innerHTML = `
                        <span class="modal-list-entry-name">‡∏ô‡∏∏‡πâ‡∏á${reader.user}</span>
                        <span class="modal-list-entry-pages">${reader.pages} ‡∏´‡∏ô‡πâ‡∏≤</span>
                    `;
                    modalListContent.appendChild(readerItem);
                });
            }

            detailsModalOverlay.classList.add('open');
        }

        /**
         * Hides the details modal.
         */
        function hideDetailsModal() {
            detailsModalOverlay.classList.remove('open');
        }

        /**
         * Renders the appropriate view based on currentView.
         */
        function renderViews() {
            // Remove active class from all view buttons
            viewByPersonButton.classList.remove('active');
            viewByBookButton.classList.remove('active');
            viewByTeacherButton.classList.remove('active');

            if (currentView === 'person') {
                renderPersonCards(userData, groupFilterSelect.value);
                viewByPersonButton.classList.add('active');
            } else if (currentView === 'book') {
                renderBookTitles(booksData, bookSearchInput.value, currentBookSortOrder);
                viewByBookButton.classList.add('active');
            } else if (currentView === 'teacher') {
                renderTeacherDashboard();
                viewByTeacherButton.classList.add('active');
                populateDropdowns(); // Re-populate dropdowns when teacher view is shown
            }
        }

        /**
         * Sends data to Google Apps Script for CUD operations.
         * @param {Object} payload - The data to send to the Apps Script.
         */
        async function sendDataToAppsScript(payload) {
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', 'info');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    // REMOVED mode: 'no-cors'
                    headers: {
                        'Content-Type': 'application/json', // CHANGED to application/json
                    },
                    body: JSON.stringify(payload)
                });

                // Now we can read the response directly since mode is default 'cors'
                if (!response.ok) {
                    const errorText = await response.text(); // Try to get error text
                    throw new Error(`‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${response.status}: ${errorText}`);
                }
                const result = await response.json(); // Expect JSON response

                if (result.success) {
                    showToast('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà...', 'success');
                    await fetchData(); // Re-fetch data to update the UI
                } else {
                    throw new Error(result.message || '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }

            } catch (error) {
                console.error('Error sending data to Apps Script:', error);
                showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', fetchData); // Fetch data on page load

        // Event delegation for clicks on person cards and book title cards
        document.addEventListener('click', (event) => {
            let target = event.target;
            // Traverse up the DOM tree to find a clickable item with data-id and data-type
            while (target && target !== document.body && !target.dataset.id) {
                target = target.parentNode;
            }

            if (target && target.dataset.id && target.dataset.type) {
                const id = target.dataset.id;
                const type = target.dataset.type;

                if (type === 'person') {
                    showUserDetails(id);
                } else if (type === 'book') {
                    showBookDetails(id);
                }
            }
        });

        // Modal close button
        modalCloseButton.addEventListener('click', hideDetailsModal);
        // Close modal if clicked outside the content
        detailsModalOverlay.addEventListener('click', (event) => {
            if (event.target === detailsModalOverlay) {
                hideDetailsModal();
            }
        });

        // View toggle buttons
        viewByPersonButton.addEventListener('click', () => {
            currentView = 'person';
            renderViews();
        });

        viewByBookButton.addEventListener('click', () => {
            currentView = 'book';
            renderViews();
        });

        viewByTeacherButton.addEventListener('click', () => {
            currentView = 'teacher';
            renderViews();
        });

        // Person View Filter
        groupFilterSelect.addEventListener('change', () => {
            if (currentView === 'person') {
                renderPersonCards(userData, groupFilterSelect.value);
            }
        });

        // Book View Search
        bookSearchInput.addEventListener('keyup', () => {
            if (currentView === 'book') {
                renderBookTitles(booksData, bookSearchInput.value, currentBookSortOrder);
            }
        });

        // Book View Sort Buttons
        sortAzButton.addEventListener('click', () => {
            currentBookSortOrder = 'az';
            sortAzButton.classList.add('active');
            sortZaButton.classList.remove('active');
            if (currentView === 'book') {
                renderBookTitles(booksData, bookSearchInput.value, currentBookSortOrder);
            }
        });

        sortZaButton.addEventListener('click', () => {
            currentBookSortOrder = 'za';
            sortZaButton.classList.add('active');
            sortAzButton.classList.remove('active');
            if (currentView === 'book') {
                renderBookTitles(booksData, bookSearchInput.value, currentBookSortOrder);
            }
        });

        // Teacher Dashboard Actions
        addDataButton.addEventListener('click', async () => {
            const personName = addPersonNameInput.value.trim();
            const bookTitle = addBookTitleInput.value.trim();
            const pageCount = parseInt(addPageCountInput.value);

            if (!personName || !bookTitle || isNaN(pageCount) || pageCount <= 0) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•, ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤ > 0)', 'error');
                return;
            }

            await sendDataToAppsScript({
                action: 'add',
                person: personName,
                book: bookTitle,
                pages: pageCount
            });

            // Clear form fields
            addPersonNameInput.value = '';
            addBookTitleInput.value = '';
            addPageCountInput.value = '';
        });

        editDataButton.addEventListener('click', async () => {
            const personName = editPersonSelect.value;
            const bookTitle = editBookSelect.value;
            const newPageCount = parseInt(editPageCountInput.value);

            if (!personName || !bookTitle || isNaN(newPageCount) || newPageCount < 0) { // Allow 0 to clear pages
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•, ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (>= 0)', 'error');
                return;
            }

            await sendDataToAppsScript({
                action: 'edit',
                person: personName,
                book: bookTitle,
                pages: newPageCount
            });

            // Clear form fields
            editPersonSelect.value = '';
            editBookSelect.value = '';
            editPageCountInput.value = '';
            updateBookDropdownForPerson(editPersonSelect, editBookSelect, false); // Reset book dropdown
        });

        deleteDataButton.addEventListener('click', async () => {
            const personName = deletePersonSelect.value;
            const bookTitle = deleteBookSelect.value; // Optional

            if (!personName) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                return;
            }

            // Confirmation dialog (simple message, not alert)
            const confirmDelete = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á "‡∏ô‡∏∏‡πâ‡∏á${personName}" ${bookTitle ? `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ "${bookTitle}"` : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
            if (!confirmDelete) {
                showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', 'info');
                return;
            }

            await sendDataToAppsScript({
                action: 'delete',
                person: personName,
                book: bookTitle || null // Send null if no specific book is selected
            });

            // Clear form fields
            deletePersonSelect.value = '';
            deleteBookSelect.value = '';
            updateBookDropdownForPerson(deletePersonSelect, deleteBookSelect, true); // Reset book dropdown
        });

        // Dynamic book dropdown update for edit/delete sections
        editPersonSelect.addEventListener('change', () => {
            updateBookDropdownForPerson(editPersonSelect, editBookSelect, false);
            // Pre-fill current page count if a book is selected
            const selectedPerson = editPersonSelect.value;
            const selectedBook = editBookSelect.value;
            if (selectedPerson && selectedBook) {
                const personData = userData.find(user => user.user === selectedPerson);
                const bookData = personData?.books.find(book => book.title === selectedBook);
                editPageCountInput.value = bookData ? bookData.pages : '';
            } else {
                editPageCountInput.value = '';
            }
        });

        editBookSelect.addEventListener('change', () => {
            const selectedPerson = editPersonSelect.value;
            const selectedBook = editBookSelect.value;
            if (selectedPerson && selectedBook) {
                const personData = userData.find(user => user.user === selectedPerson);
                const bookData = personData?.books.find(book => book.title === selectedBook);
                editPageCountInput.value = bookData ? bookData.pages : '';
            } else {
                editPageCountInput.value = '';
            }
        });

        deletePersonSelect.addEventListener('change', () => {
            updateBookDropdownForPerson(deletePersonSelect, deleteBookSelect, true);
        });

        // Simple custom confirm dialog (replaces window.confirm)
        function confirm(message) {
            return window.confirm(message); // Using native confirm for simplicity as per previous instruction to avoid alert/confirm, but now it's explicitly requested for confirmation.
                                          // For a truly custom UI, this would be a modal.
        }
    </script>
</body>
</html>
